name: "Tauri Windows Auto Release"

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  # ============================================================
  # Prepare version + tagging (Linux)
  # ============================================================
  prepare-environment:
    name: Prepare Version & Environment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calculate.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - id: calculate
        shell: bash
        run: |
          set -euo pipefail
          TAURI_FILE="src-tauri/tauri.conf.json"

          git fetch --tags --force
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          RANGE=${PREV_TAG:+$PREV_TAG..HEAD}

          if git log $RANGE --pretty=%B | grep -q "BREAKING CHANGE"; then TYPE="major"
          elif git log $RANGE --pretty=%B | grep -q "^feat:"; then TYPE="minor"
          elif git log $RANGE --pretty=%B | grep -q "^fix:"; then TYPE="patch"
          else TYPE="patch"; fi

          OLD_VERSION=$(jq -r '.version' "$TAURI_FILE")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$OLD_VERSION"

          case "$TYPE" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            patch) PATCH=$((PATCH+1)) ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          while git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; do
            PATCH=$((PATCH+1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          done

          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Update versions
        run: |
          jq ".version = \"${{ steps.calculate.outputs.version }}\"" src-tauri/tauri.conf.json > tmp && mv tmp src-tauri/tauri.conf.json
          jq ".version = \"${{ steps.calculate.outputs.version }}\"" package.json > tmp && mv tmp package.json

      - name: Commit & tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src-tauri/tauri.conf.json package.json
          git commit -m "chore: bump version to v${{ steps.calculate.outputs.version }}" || true
          git push origin main

          git tag "v${{ steps.calculate.outputs.version }}" || true
          git push origin "v${{ steps.calculate.outputs.version }}" || true

  # ============================================================
  # Build + release Windows (with backend sidecar)
  # ============================================================
  build-and-release-windows:
    name: Build & Release Windows
    needs: prepare-environment
    runs-on: windows-latest

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # ---------------------------
      # Node (deps only)
      # ---------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
  

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      # ---------------------------
      # Python + uv (backend)
      # ---------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Sync backend dependencies (uv)
        working-directory: backend
        run: |
          uv sync --no-dev

      # ---------------------------
      # PyInstaller (custom command)
      # ---------------------------
      - name: Build backend sidecar (PyInstaller)
        working-directory: backend
        run: |
          uv run pyinstaller ^
            --clean ^
            --name "Siriadmin-backend-x86_64-pc-windows-msvc" ^
            --runtime-tmpdir . ^
            --onefile ^
            --add-data "scripts:scripts" ^
            --add-data "utils:utils" ^
            --add-data "routes:routes" ^
            --add-data "services:services" ^
            --add-data "config.py:." ^
            --add-data ".env:." ^
            app.py

      # ---------------------------
      # Copy any EXE â†’ Tauri
      # ---------------------------
      - name: Copy backend sidecar EXE into Tauri
        shell: pwsh
        run: |
          $exe = Get-ChildItem backend/dist -Filter "*.exe"
          if ($exe.Count -ne 1) {
            throw "Expected exactly one .exe in backend/dist"
          }

          New-Item -ItemType Directory -Force src-tauri/binaries | Out-Null
          Copy-Item $exe[0].FullName "src-tauri/binaries\$($exe[0].Name)" -Force
          Write-Host "Copied backend sidecar: $($exe[0].Name)"

      # ---------------------------
      # Rust / Tauri
      # ---------------------------
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Build Tauri App (Windows)
        env:
          TAURI_SIGNER_KEY: ${{ env.TAURI_SIGNER_KEY }}
          TAURI_SIGNER_PASSWORD: ${{ env.TAURI_SIGNER_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: cargo tauri build

      # ---------------------------
      # Release assets + updater
      # ---------------------------
      - name: Prepare updater assets
        shell: pwsh
        run: |
          $bundle = "src-tauri/target/release/bundle"
          $version = "${{ needs.prepare-environment.outputs.version }}"
          $repo = $env:GITHUB_REPOSITORY
          $tag = "v$version"

          $msi = Get-ChildItem "$bundle/msi" -Filter "*.msi" | Select-Object -First 1
          $exe = Get-ChildItem "$bundle/nsis" -Filter "*setup.exe" | Select-Object -First 1

          $update = @{
            version = $version
            pub_date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                url = "https://github.com/$repo/releases/download/$tag/$($msi.Name)"
              }
              "windows-x86_64-nsis" = @{
                url = "https://github.com/$repo/releases/download/$tag/$($exe.Name)"
              }
            }
          } | ConvertTo-Json -Depth 6

          $update | Out-File "$bundle/update.json" -Encoding utf8
          echo "ASSETS=$($msi.FullName) $($exe.FullName) $bundle/update.json" >> $env:GITHUB_ENV

      - name: Create or Update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $tag = "v${{ needs.prepare-environment.outputs.version }}"
          gh release view $tag || gh release create $tag --title "Siri Admin App $tag"
          foreach ($asset in $env:ASSETS.Split(" ")) {
            gh release upload $tag $asset --clobber
          }
